<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Steem Keychain バージョン検出ツール（v3/v4 対応）</title>
<style>
body { font-family: Arial; padding: 20px; }
button { padding: 6px 18px; margin-right: 10px; }
#log { white-space: pre-wrap; background: #f8f8f8; padding: 15px; border-radius: 8px; }
</style>
</head>
<body>

<h2>Steem Keychain バージョン検出ツール（v3/v4 対応）</h2>

<button onclick="startCheck()">Keychain バージョン確認</button>
<button onclick="clearLog()">ログ消去</button>

<div id="log"></div>

<script>
// ログ追加
function log(msg) {
    document.getElementById("log").innerText += msg + "\n";
}

// ログ消去
function clearLog() {
    document.getElementById("log").innerText = "";
}

// ----------------------------
// v3 / v4 両対応 Keychain 検出関数
// ----------------------------
function detectKeychainVersion() {
    return new Promise((resolve) => {

        let result = {
            exists: false,
            protocol: "unknown",
            version: "unknown"
        };

        // Keychain 拡張がない
        if (!window.steem_keychain) {
            resolve(result);
            return;
        }

        result.exists = true;

        log("window.steem_keychain が検出されました。");

        // postMessage 監視
        const handler = (event) => {
            if (!event.data) return;

            // ---- v3 ----
            if (event.data.type === "steem_keychain_handshake") {
                log("postMessage: v3 handshake 検出");
                result.protocol = "v3";
                window.removeEventListener("message", handler);
                resolve(result);
            }

            // ---- v4 ----
            if (event.data.type === "keychain_handshake") {
                log("postMessage: v4 handshake 検出");
                result.protocol = "v4";
                result.version = event.data.msg || "unknown";
                window.removeEventListener("message", handler);
                resolve(result);
            }
        };

        window.addEventListener("message", handler);

        // handshake 実行
        log("requestHandshake を送信します…");

        window.steem_keychain.requestHandshake((callbackResult) => {
            log("callback 受信: " + JSON.stringify(callbackResult));

            // v4 はここで version が返る
            if (callbackResult && typeof callbackResult === "object") {
                result.protocol = "v4";
                result.version = callbackResult.msg || "unknown";
                resolve(result);
            }

            // v3 は undefined
        });

        // 念のためタイムアウト
        setTimeout(() => resolve(result), 1500);
    });
}

// 実行ボタン
async function startCheck() {
    clearLog();
    log("★ Keychain バージョン確認を開始…\n");

    const info = await detectKeychainVersion();

    log("\n=== 判定結果 =====================");
    log("Keychain 拡張: " + (info.exists ? "あり" : "なし"));
    log("プロトコル:   " + info.protocol);
    log("バージョン:   " + info.version);
    log("=================================\n");
}
</script>

</body>
</html>
