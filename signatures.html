<html>
    <head></head>
<body>
<script>

 
if(window.steem_keychain){
  // JSONの内容をコピー

// steem_keychain.requestBroadcast(
//   "usay",
//   JSON.parse(tx),
//   "active",
//   function(res){
//     console.log(res);
//   }
// );

}
</script>
<!---->
<textarea id="myText" rows="15" cols="40" placeholder="複数行テキストを入力してください">
</textarea>
<br>
<button onclick="signatureText()">署名</button>
<br>
<textarea id="result" rows="15" cols="40"></textarea>

<script>
//トランザクションをバイナリ化 → SHA256 ハッシュを作成
async function getTxHash(transaction) {
    const txString = JSON.stringify(transaction);
 console.info(txString);

    const encoder = new TextEncoder();
    const data = encoder.encode(txString);
 console.info(data);

    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex;
}
async function signatureText() {
  if (!window.steem_keychain) {
    resultEl.textContent = "❌ Steem Keychain がインストールされていません。";
    return;
  }
  
  message = document.getElementById("myText").value;
  const transaction = JSON.parse(message)

  // ② Keychain で署名を作成
  steem_keychain.requestSignBuffer("usay", getTxHash(transaction), "active", async (res) => {
    if (!res.success) {
      resultEl.textContent = "署名に失敗しました。";
      return;
    }
    console.info(res);
    console.info(res.success);

    document.getElementById("result").value = res.result;
  });
}

</script>
<!---->
</body>
</html>