<html>
<head>
<meta charset="utf-8">
<title>Steem 手動署名 & 送信ツール</title>
</head>
<body>

<h3>① 署名するトランザクション JSON</h3>
<textarea id="tx" rows="15" cols="60"></textarea>
<br><br>

<button onclick="signTx()">② Keychain で署名する</button>
<button onclick="broadcastTx()">③ RPC へ送信</button>

<h3>結果</h3>
<textarea id="result" rows="20" cols="60"></textarea>

<script>
// -------------------------------------------
// ① トランザクションの JSON → SHA256 ハッシュ
// -------------------------------------------
async function getTxHash(tx) {
    const json = JSON.stringify(tx);
    const data = new TextEncoder().encode(json);
    const hash = await crypto.subtle.digest("SHA-256", data);
    return [...new Uint8Array(hash)]
        .map(x => x.toString(16).padStart(2, "0"))
        .join("");
}

// -------------------------------------------
// ② Keychain 署名
// -------------------------------------------
let lastTx = null;      // JSON パース済みトランザクション
let lastSignature = ""; // Keychain 署名結果

async function signTx() {
    const resultEl = document.getElementById("result");
    const raw = document.getElementById("tx").value;

    try {
        lastTx = JSON.parse(raw);
    } catch (e) {
        resultEl.value = "❌ JSON parse error: " + e.message;
        return;
    }

    if (!window.steem_keychain) {
        resultEl.value = "❌ Steem Keychain が見つかりません";
        return;
    }

    const hash = await getTxHash(lastTx);

    steem_keychain.requestSignBuffer(
        "usay",          // 署名するアカウント
        hash,            // 署名対象データ
        "active",        // active キーで署名
        (res) => {
            if (!res.success) {
                resultEl.value = "❌ Keychain 署名失敗";
                return;
            }

            lastSignature = res.result;
            resultEl.value =
                "✔ 署名成功\n" +
                "signature: " + lastSignature + "\n";
        }
    );
}


// -------------------------------------------
// ③ RPC 送信（signatures に署名を追加）
// -------------------------------------------
async function broadcastTx() {
    const resultEl = document.getElementById("result");

    if (!lastTx) {
        resultEl.value = "❌ 先に署名してください";
        return;
    }
    if (!lastSignature) {
        resultEl.value = "❌ 署名がありません";
        return;
    }

    // signatures に追加
    lastTx.signatures = [lastSignature];

    // RPC 用 JSON-RPC
    const rpcBody = {
        id: "0",
        jsonrpc: "2.0",
        method: "call",
        params: [
            "condenser_api",
            "broadcast_transaction_synchronous",
            [ lastTx ]
        ]
    };

    // POST
    const res = await fetch("https://api.steememory.com/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(rpcBody)
    });

    const data = await res.text();
    resultEl.value = "RPC Response:\n" + data;
}
</script>

</body>
</html>
